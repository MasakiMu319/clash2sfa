<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sing-box Config Convertor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/picocss/1.5.7/pico.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"
        integrity="sha512-g2TeAWw5GPnX7z0Kn8nFbYfeHcvAu/tx6d6mrLe/90mkCxO+RcptyYpksUz35EO337F83bZwcmUyHiHamspkfg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-base64@3.7.5/base64.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
    <style type="text/css">
        header {
            border-bottom: 1px solid #e5e5e5;
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <div id="app">
        <header>
            <nav class="container-fluid">
                <ul>
                    <li><strong>Sing-box Config Convertor</strong></li>
                </ul>
                <ul>
                </ul>
            </nav>
        </header>
        <main class="container">
            <p>A tool to convert clash-formatted subscription links to single-box, the converted links can be used for <a
                    href="https://sing-box.sagernet.org/">Sing-box</a>.</p>
            <p>Paste the subscription link generated by this tool on this page (only parameters saved within the link are available), which can be parsed into the options below.</p>
            <input placeholder="Subscription links, use | slitting multiple links" v-model="sub" />
            <div class="grid">
                <input placeholder="The node name contained in the url test (regular rules are available)" v-model="include" />
                <input placeholder="Excluded node names in URL test (regular rules available)" v-model="exclude" />
            </div>
            <label for="switch">
                <input type="checkbox" id="switch" name="switch" role="switch" v-model="saveType">
                {{ saveTypeText }}
            </label>
            <label for="addTag">
                <input type="checkbox" id="addTag" role="switch" v-model="addTag">
                Add the domain name of the subscription address
            </label>
            <br />
            <details>
                <summary>Advance</summary>
                <br />
                <details>
                    <summary>Profile Template</summary>
                    <label>
                        <input type="checkbox" role="switch" v-model="checkbox">
                        External Profile Template
                    </label>
                    <textarea style="resize: none;height: 25em;" v-model="config" v-show="!checkbox"></textarea>
                    <input v-model="configurl" v-show="checkbox" />
                </details>
                <details>
                    <summary>Custom urltest / selector</summary>
                    <div class="grid">
                        <label>
                            tag
                            <input type="text" placeholder="group name" v-model.trim="customValue.tag" required>
                        </label>
                        <label>
                            tolerance
                            <input type="text" placeholder="50" v-model.trim="customValue.tolerance" required>
                        </label>
                        <label>
                            include
                            <input type="text" placeholder="available regular" v-model.trim="customValue.include" required>
                        </label>
                        <label>
                            exclude
                            <input type="text" placeholder="" v-model.trim="customValue.exclude" required>
                        </label>
                        <label>
                            type
                            <select required v-model="customValue.type">
                                <option value="urltest" selected>urltest</option>
                                <option value="selector">selector</option>
                            </select>
                        </label>
                        <label style="display: flex;flex-direction:column-reverse">
                            <button @click="addUrlTables(customValue)" style="height: min-content;">Add</button>
                        </label>
                    </div>
                    <table role="grid" v-show="customTables.length != 0">
                        <thead>
                            <tr>
                                <th scope="col">tag</th>
                                <th scope="col">tolerance</th>
                                <th scope="col">include</th>
                                <th scope="col">exclude</th>
                                <th scope="col">type</th>
                                <th scope="col"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(v,index) in customTables" :key="index">
                                <th scope="row">{{ v.tag }}</th>
                                <td>{{ v.tolerance }}</td>
                                <td>{{ v.include }}</td>
                                <td>{{ v.exclude }}</td>
                                <td>{{ v.type }}</td>
                                <td>
                                    <button @click="customTables.splice(index,1)"
                                        style="height: min-content;">Del</button>
                                </td>
                            </tr>
                    </table>
                </details>
            </details>
            <progress v-show="inFetch"></progress>
            <button v-show="!inFetch" @click="click">Get the subscription link in single-box format</button>
            <input type="text" ref="inputRef" v-if="newsub" placeholder="" v-model="newsub">
        </main>
    </div>
</body>

<script type="module">
    Vue.createApp({
        setup(props, context) {
            const sub = Vue.ref('');
            const newsub = Vue.ref('');
            const include = Vue.ref('');
            const exclude = Vue.ref('');
            const config = Vue.ref('loading...');
            const checkbox = Vue.ref(false)
            const configurl = Vue.ref('');
            const saveType = Vue.ref(true);
            const saveTypeText = Vue.ref('Parameters are saved within the link');
            const customValue = Vue.ref({
                type: "urltest"
            });
            const customTables = Vue.ref([]);
            const inFetch = Vue.ref(false)
            const inputRef = Vue.ref(null)
            const addTag = Vue.ref(false)

            Vue.watch(saveType, v => {
                if (v) {
                    saveTypeText.value = "Parameters are saved within the link"
                } else {
                    saveTypeText.value = "Parameters are saved on the server side"
                }
            })

            Vue.watch(checkbox, v => {
                if (v) {
                    config.value = oldConfig
                } else {
                    configurl.value = ""
                }
            })


            let oldConfig = "";

            (async () => {
                const f = await fetch("/config")
                config.value = await f.text()
                oldConfig = config.value
            })();

            function saveParameter() {
                const subUrl = new URL(new URL(location.href).origin)
                subUrl.pathname = "/sub"
                const c = config.value != oldConfig ? config.value : ""
                if (c != "") {
                    const compressed = pako.deflate(config.value);
                    const base64String = Base64.fromUint8Array(compressed, true)
                    subUrl.searchParams.set("config", base64String)
                }
                const ct = customTables.value.length != 0 ? JSON.stringify(customTables.value) : ""
                if (ct != "") {
                    const compressed = pako.deflate(ct);
                    const base64String = Base64.fromUint8Array(compressed, true)
                    subUrl.searchParams.set("urltest", base64String)
                }
                configurl.value && subUrl.searchParams.set("configurl", configurl.value)
                include.value && subUrl.searchParams.set("include", include.value)
                exclude.value && subUrl.searchParams.set("exclude", exclude.value)
                addTag.value && subUrl.searchParams.set("addTag", "true")
                subUrl.searchParams.set("sub", sub.value)
                return subUrl.toString()
            }

            async function saveServer() {
                const u = new URL(new URL(location.href).origin)
                u.pathname = "/put"

                const c = config.value != oldConfig ? config.value : ""

                const text = await (await fetch(u.toString(), {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        "Sub": sub.value,
                        "Include": include.value,
                        "Exclude": exclude.value,
                        "Config": c,
                        "ConfigUrl": configurl.value,
                        "UrlTest": customTables.value,
                        "AddTag": addTag.value,
                    })
                })).text()
                const subUrl = new URL(new URL(location.href).origin)
                subUrl.pathname = "/sub"
                subUrl.searchParams.set("id", text)
                return subUrl.toString()
            }


            function catchSome(f, onfail) {
                const nf = async (...a) => {
                    try {
                        return await f(...a);
                    } catch (e) {
                        if (onfail) {
                            onfail()
                        }
                        console.warn(e)
                        alert(String(e))
                    }
                }
                return nf
            }



            const click = catchSome(async () => {
                if (sub.value == "") {
                    return ""
                }
                if (inFetch.value) {
                    return
                }
                newsub.value = ""
                inFetch.value = true
                const subURL = await (async () => {
                    if (saveType.value) {
                        return saveParameter()
                    } else {
                        return await saveServer()
                    }
                })()
                const f = await fetch(subURL)
                if (!f.ok) {
                    const msg = await f.text()
                    newsub.value = msg
                    console.warn(msg)
                    inFetch.value = false
                    alert("错误 " + msg)
                    return
                }
                inFetch.value = false
                newsub.value = subURL
                await Vue.nextTick()
                inputRef.value.scrollIntoView({ behavior: "smooth" })
                inputRef.value.select()
                document.execCommand('copy', true);
                alert("已复制到粘贴板")
            }, () => {
                inFetch.value = false
            })

            function addUrlTables(v) {
                customTables.value.push(Object.assign({}, Vue.toRaw(v)))
            }

            document.addEventListener('paste', async (event) => {
                const items = event.clipboardData && event.clipboardData.items;
                for (const v of items) {
                    if (v.kind == "file") continue

                    v.getAsString(v => {
                        try {
                            const u = new URL(v)
                            if (u.pathname != "/sub") {
                                return
                            }
                            if (!confirm("解析粘贴的订阅链接？")) {
                                return
                            }
                            const c = u.searchParams.get("config")
                            if (c && c != "") {
                                const d = pako.inflate(Base64.toUint8Array(c), { to: "string" });
                                config.value = d
                            }
                            const ur = u.searchParams.get("urltest")
                            if (ur && ur != "") {
                                const d = pako.inflate(Base64.toUint8Array(ur), { to: "string" });
                                customTables.value = JSON.parse(d)
                            }
                            const cu = u.searchParams.get("configurl")
                            if (cu && cu != "") {
                                configurl.value = cu
                                checkbox.value = true
                                config.value = oldConfig
                            } else {
                                configurl.value = ""
                            }
                            include.value = u.searchParams.get("include") || include.value
                            exclude.value = u.searchParams.get("exclude") || exclude.value
                            sub.value = u.searchParams.get("sub") || sub.value
                            addTag.value = u.searchParams.get("addTag") === "true"
                        } catch (error) {
                            console.log(error)
                            return
                        }
                    })

                }
            });


            return {
                sub,
                config,
                include,
                exclude,
                newsub,
                click,
                checkbox,
                configurl,
                saveType,
                saveTypeText,
                customValue,
                customTables,
                addUrlTables,
                inFetch,
                inputRef,
                addTag
            }

        },
    }).mount('#app')   
</script>

</html>